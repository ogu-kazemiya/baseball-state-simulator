# Baseball State Simulator

野球の攻撃状態をマルコフ過程としてモデル化し、得点期待値や得点確率分布を算出するツールです。
任意の選手データを使用して、特定の打順や状況における得点能力を定量的に評価できます。


## 概要

このプロジェクトでは、野球の攻撃を25状態の吸収マルコフ過程として定義しています。
一時的状態は24状態(アウトカウント × 走者状況 = $3 \times 2^3$)、吸収状態は1状態(3アウト)です。

### 主な機能
- **進塁モデル構築**: MLBのStatcastデータをもとに、各打撃イベント(単打や三振など)ごとの遷移確率行列を構築します。
- **得点期待値の算出**: 任意の打順に対して、イニング終了までの得点期待値を解析的に算出します。
- **得点確率分布の推定**: モンテカルロ法によって、任意の打順や状況からの得点確率の分布を推定します。


## セットアップ

必要条件: Python 3.10+

1. リポジトリをクローンまたはダウンロード
2. 必要に応じて仮想環境を作成
3. 依存ライブラリをインストール

```bash
pip install -r requirements.txt
```

## 使い方

ひと通りの使用例は `scripts/` にあります。
`scripts/run_modeling.py` と `scripts/run_analysis.py` を順に実行してみてください。

### 進塁モデルの構築
まず、MLBのStatcastデータを取得し、打撃イベント(単打/二塁打/三塁打/本塁打/四球/三振/凡打)ごとの進塁モデルを作成します。
デフォルトでは `data/statcast/` にStatcastデータをキャッシュし、 `data/artifacts/main_model.npz` に作成したモデルを保存します。

### 選手データの処理
`data/stats/` に選手の成績データをCSV形式で保存することで、データを読み込んで任意の打順を組むことができます。
データは[Baseball Reference](https://www.baseball-reference.com/)からCSVをエクスポートするのが簡単です(NPBデータもあります)。

### 分析
分析に使用できる関数は `analysis/__init__.py` と `players/__init__.py` を参照してください。
例えば、以下のような分析が可能です。

- 実際の選手成績データをもとに、打順ごとの得点期待値を計算する。
- 無死一塁と一死二塁の得点確率分布を比較して、バントすべきかを判断する。
- 打順を任意に組みかえて、どこで代打を出すのが最適かを調べる。

### ディレクトリ構成
- `src/` : ソースコード
  - `models/` : Statcastデータの読み込み、進塁モデルの構築
  - `players/` : 選手成績CSVの読み込み、打撃確率への変換
  - `analysis/` : 行列演算による期待値計算、モンテカルロシミュレーション
  - `common/` : 定数定義、ユーティリティ
- `scripts/` : 実行用スクリプト
- `data/` : データ格納
  - `examples/` : 選手成績CSVのサンプル

### 進塁モデルについて
分析には、独自の進塁モデルを使用します(より単純なD'Esopo & Lefkowitz進塁モデルも使用できます)。
このモデルでは、Statcastデータをもとに打撃イベントごとの状態遷移をカウントして遷移行列を構築しています。
例えば、2塁走者が単打で生還する確率がアウトカウントごとに異なることを反映できます。

走者はすべて平均的な走塁能力をもつことを前提にしており、個別の走塁能力は考慮できません。
また、フライアウトとゴロアウトの区別は実装できていません。
3アウトに遷移した時の得点は0としています。


## データ出典

本プロジェクトでは、分析のために以下のデータソースを使用しています。

- [Baseball Reference](https://www.baseball-reference.com/): 選手成績のCSVデータ
- [Baseball Savant](https://baseballsavant.mlb.com/) (via pybaseball) : Statcastデータ
